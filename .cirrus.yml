debian_task:
  container:
    dockerfile: debian.dockerfile
  env:
    matrix:
      - TAG: v3.8.0
      - TAG: v3.7.5
  checkout_script:
    - git clone --depth 1 --branch $TAG https://github.com/python/cpython.git
  build_script: |
    cd cpython
    # Prepend *static* to file
    echo "*static*" > /tmp/setup
    cat Modules/Setup* >> /tmp/setup
    cp /tmp/setup Modules/Setup
    # Configure
    ./configure "LDFLAGS=-static -static-libgcc" "CPPFLAGS=-static" --disable-shared
    # Build
    make "LDFLAGS=-static" "LINKFORSHARED= "
  test_script:
    # The python:3.8 container says:
    # ['__main__', '_abc', '_codecs', '_frozen_importlib', '_frozen_importlib_external', '_imp', '_signal', '_stat', '_thread', '_warnings', '_weakref', 'builtins', 'io', 'marshal', 'posix', 'sys', 'time', 'zipimport']
    - ./cpython/python -c "print(sorted(m.__name__ for m in __import__('sys').modules.values() if not hasattr(m, '__file__')))"
    - ./cpython/python test-imports.py
  binary_artifacts:
    path: cpython/python
  library_artifacts:
    path: cpython/libpython*.a
